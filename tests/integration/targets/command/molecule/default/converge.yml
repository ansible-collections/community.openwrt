---
- name: Converge
  hosts: all
  gather_facts: false
  roles:
    - role: community.openwrt.init
      vars:
        openwrt_install_recommended_packages: true
  pre_tasks:
    - name: Install dropbear SSH server using docker exec
      ansible.builtin.command:
        cmd: |
          docker exec {{ inventory_hostname }} sh -c '
            mkdir -p /var/lock
            opkg update
            opkg install dropbear
            passwd -d root
          '
      delegate_to: localhost
      changed_when: true

    - name: Start dropbear in background
      ansible.builtin.command:
        cmd: docker exec -d {{ inventory_hostname }} /usr/sbin/dropbear -R -F -B -p 22
      delegate_to: localhost
      changed_when: true

    - name: Wait for SSH to be available
      ansible.builtin.wait_for:
        port: "{{ ansible_port }}"
        host: 127.0.0.1
        delay: 2
        timeout: 30
      delegate_to: localhost
